<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>個人損益計算書（PL）ジェネレーター</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #111827;
      --panel-2: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #60a5fa;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #f59e0b;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic UI", Meiryo, sans-serif;
      background: linear-gradient(120deg, #0a0f1a, #0b1220 60%, #0a0f1a);
      color: var(--text);
    }
    header { position: sticky; top: 0; z-index: 50; background: rgba(11,15,20,.6); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); }
    .container { max-width: 1100px; margin: 0 auto; padding: 18px 16px; }
    .title { font-weight: 800; letter-spacing: .02em; font-size: clamp(20px, 3vw, 28px); display: flex; align-items: center; gap: 10px; }
    .badge { font-size: 12px; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 999px; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 960px) { .grid { grid-template-columns: 1.2fr .8fr; } }

    .card { background: radial-gradient(1200px 400px at -10% -10%, #162036 0%, transparent 40%) , var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin: 0 0 8px; font-size: 18px; letter-spacing: .02em; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .row > * { margin: 4px 0; }

    .toolbar { display:flex; flex-wrap: wrap; gap: 8px; }
    button, .btn {
      appearance: none; border: 1px solid var(--border); background: linear-gradient(180deg, #182235, #121a2b); color: var(--text);
      padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing: .02em;
    }
    button:hover { filter: brightness(1.05); }
    .btn-ghost { background: transparent; }
    .btn-accent { background: linear-gradient(180deg, #1d4ed8, #1e3a8a); border-color: #1d4ed8; }
    .btn-green { background: linear-gradient(180deg, #16a34a, #065f46); border-color: #16a34a; }
    .btn-red { background: linear-gradient(180deg, #b91c1c, #7f1d1d); border-color: #b91c1c; }

    select, input[type="number"], input[type="text"] {
      background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; outline: none; min-width: 0;
    }
    input[type="number"] { width: 130px; text-align: right; }
    input[type="text"] { width: 180px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px dashed var(--border); padding: 10px 6px; }
    th { text-align: left; color: var(--muted); font-weight: 600; }
    tbody tr:hover { background: rgba(96,165,250,0.06); }

    .section-head { display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px; }
    .section-head h3 { margin:0; font-size: 16px; letter-spacing: .02em; }

    .summary { display:grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
    .pill {
      padding: 14px; background: linear-gradient(180deg, #0f172a, #0b1220); border: 1px solid var(--border); border-radius: 12px;
      display:flex; flex-direction: column; gap: 6px; min-height: 78px;
    }
    .pill .label { color: var(--muted); font-size: 12px; letter-spacing: .04em; text-transform: uppercase; }
    .pill .value { font-size: 20px; font-weight: 800; }
    .pill.positive .value { color: var(--green); }
    .pill.negative .value { color: var(--red); }

    .hint { color: var(--muted); font-size: 12px; }

    canvas { width: 100%; height: 280px; background: #0b1220; border: 1px solid var(--border); border-radius: 12px; }

    footer { color: var(--muted); font-size: 12px; text-align: center; padding: 24px; }

    @media print {
      header, .toolbar, .hint, .btn, .btn-ghost, .btn-accent, .btn-green, .btn-red { display:none !important; }
      body { background: #fff; color:#000; }
      .card { box-shadow: none; border: 1px solid #ccc; }
      .pill { border-color: #ccc; }
      canvas { display:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content: space-between;">
      <div class="title">個人損益計算書（PL）<span class="badge">月/年 自動換算・保存・CSV</span></div>
      <div class="row">
        <label class="row" style="gap:6px; align-items:center;">
          <span class="hint">表示</span>
          <select id="viewMode">
            <option value="monthly">月次</option>
            <option value="yearly">年次</option>
          </select>
        </label>
        <button id="printBtn" class="btn-ghost">印刷 / PDF</button>
      </div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <div class="section-head">
        <h2>入力（収入 / 支出）</h2>
        <div class="toolbar">
          <button id="addIncome" class="btn-accent">＋ 収入を追加</button>
          <button id="addExpense" class="btn-ghost">＋ 支出を追加</button>
          <button id="resetAll" class="btn-red">初期化</button>
        </div>
      </div>

      <div class="section">
        <div class="section-head"><h3>収入</h3><span class="hint">※金額は <strong>月額</strong> で入力してください（年表示は自動換算）</span></div>
        <table id="incomeTable">
          <thead>
            <tr><th style="width:36%">項目</th><th style="width:20%">金額（円/月）</th><th style="width:30%">メモ</th><th style="width:14%"></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="section" style="margin-top:16px;">
        <div class="section-head"><h3>支出</h3></div>
        <table id="expenseTable">
          <thead>
            <tr><th style="width:36%">項目</th><th style="width:20%">金額（円/月）</th><th style="width:30%">メモ</th><th style="width:14%"></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:12px; gap: 10px;">
        <input type="text" id="profileName" placeholder="プロフィール名（例：一人暮らし_学生）" />
        <button id="saveBtn" class="btn-green">保存</button>
        <button id="loadBtn" class="btn-ghost">読込</button>
        <button id="exportBtn" class="btn-ghost">CSV 書き出し</button>
        <label class="btn" style="position:relative; overflow:hidden;" title="CSV から読み込み">
          CSV 読み込み
          <input id="importCsv" type="file" accept=".csv" style="position:absolute; inset:0; opacity:0; cursor:pointer;" />
        </label>
      </div>
      <div class="hint">ヒント：入力は自動保存（ローカル）されます。複数パターンを作る場合は「プロフィール名」を付けて保存してください。</div>
    </section>

    <aside class="card">
      <h2>サマリー</h2>
      <div class="summary" style="margin: 8px 0 14px;">
        <div class="pill" id="incomePill"><div class="label">総収入</div><div class="value" id="totalIncome">¥0</div><div class="hint" id="incomeHint">月次</div></div>
        <div class="pill" id="expensePill"><div class="label">総支出</div><div class="value" id="totalExpense">¥0</div><div class="hint" id="expenseHint">月次</div></div>
        <div class="pill" id="profitPill"><div class="label">純利益（黒字/赤字）</div><div class="value" id="netProfit">¥0</div><div class="hint" id="profitHint">月次</div></div>
      </div>

      <canvas id="chart"></canvas>
      <div class="hint" style="margin-top:8px;">円グラフ：支出の内訳（表示モードに応じて金額自動換算）</div>
    </aside>
  </main>

  <footer>© 個人PLジェネレーター — ローカルで動作。データはご自身のブラウザ内に保存されます。</footer>

  <script>
    // ---- 初期カテゴリ（日本の個人PLで使いやすい標準セット）
    const DEFAULT_INCOME = [
      '給与', 'アルバイト', '事業収入', '投資収入', 'その他収入'
    ];
    const DEFAULT_EXPENSE = [
      '家賃', '食費', '水道光熱費', '通信費', '交通費', '教育/自己投資', '医療/保険', '交際費', '娯楽', '日用品', 'サブスク', 'その他'
    ];

    const incomeTBody = document.querySelector('#incomeTable tbody');
    const expenseTBody = document.querySelector('#expenseTable tbody');
    const viewMode = document.getElementById('viewMode');

    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpenseEl = document.getElementById('totalExpense');
    const netProfitEl = document.getElementById('netProfit');
    const incomePill = document.getElementById('incomePill');
    const expensePill = document.getElementById('expensePill');
    const profitPill = document.getElementById('profitPill');
    const incomeHint = document.getElementById('incomeHint');
    const expenseHint = document.getElementById('expenseHint');
    const profitHint = document.getElementById('profitHint');

    const fmt = new Intl.NumberFormat('ja-JP');

    // ---- 行の生成
    function createRow(name = '', amount = 0, memo = '') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="name" value="${name}"></td>
        <td><input type="number" class="amount" inputmode="numeric" min="0" step="1000" value="${amount}"></td>
        <td><input type="text" class="memo" value="${memo}" placeholder="（任意）具体的な内訳など"></td>
        <td style="text-align:right;">
          <button class="btn-ghost delRow" title="削除">削除</button>
        </td>`;
      tr.querySelector('.amount').addEventListener('input', recalc);
      tr.querySelector('.name').addEventListener('input', recalc);
      tr.querySelector('.delRow').addEventListener('click', () => {
        tr.remove(); recalc(); saveAuto();
      });
      tr.querySelector('.memo').addEventListener('input', saveAuto);
      return tr;
    }

    function seedDefaults() {
      if (!localStorage.getItem('pl_seeded')) {
        DEFAULT_INCOME.forEach((n, i) => incomeTBody.appendChild(createRow(n, 0)));
        DEFAULT_EXPENSE.forEach((n, i) => expenseTBody.appendChild(createRow(n, 0)));
        localStorage.setItem('pl_seeded', '1');
        saveAuto();
      } else {
        loadAuto();
      }
      recalc();
    }

    // ---- 計算
    function getRows(tbody) {
      return [...tbody.querySelectorAll('tr')].map(tr => ({
        name: tr.querySelector('.name').value.trim() || '（未入力）',
        amountMonthly: Number(tr.querySelector('.amount').value || 0),
        memo: tr.querySelector('.memo').value || ''
      }));
    }

    function monthlyToView(v) { return viewMode.value === 'yearly' ? v * 12 : v; }

    function recalc() {
      const incomes = getRows(incomeTBody);
      const expenses = getRows(expenseTBody);
      const sumIncomeM = incomes.reduce((a, r) => a + (r.amountMonthly||0), 0);
      const sumExpenseM = expenses.reduce((a, r) => a + (r.amountMonthly||0), 0);
      const netM = sumIncomeM - sumExpenseM;

      totalIncomeEl.textContent = '¥' + fmt.format(monthlyToView(sumIncomeM));
      totalExpenseEl.textContent = '¥' + fmt.format(monthlyToView(sumExpenseM));
      netProfitEl.textContent = '¥' + fmt.format(monthlyToView(netM));

      profitPill.classList.remove('positive', 'negative');
      if (netM >= 0) profitPill.classList.add('positive'); else profitPill.classList.add('negative');

      const label = viewMode.value === 'yearly' ? '年次' : '月次';
      incomeHint.textContent = label; expenseHint.textContent = label; profitHint.textContent = label;

      drawChart(expenses);
    }

    // ---- グラフ（支出内訳 円グラフ）
    const chartCanvas = document.getElementById('chart');
    const ctx = chartCanvas.getContext('2d');

    function drawChart(expenses) {
      const W = chartCanvas.clientWidth, H = chartCanvas.clientHeight;
      chartCanvas.width = W * devicePixelRatio; chartCanvas.height = H * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);

      ctx.clearRect(0,0,W,H);
      const centerX = W/2, centerY = H/2, radius = Math.min(W,H)/2 - 16;
      const innerR = radius * 0.55; // ドーナツ

      const totalM = expenses.reduce((a,r)=>a+(r.amountMonthly||0),0);
      if (totalM <= 0) {
        ctx.fillStyle = '#9ca3af';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.font = '14px system-ui, sans-serif';
        ctx.fillText('支出を入力すると内訳が表示されます', centerX, centerY);
        return;
      }

      // カラー生成（HSL環状）
      const n = expenses.length;
      let startAngle = -Math.PI/2;
      expenses.forEach((r, i) => {
        const val = r.amountMonthly||0; if (!val) return;
        const ratio = val / totalM;
        const endAngle = startAngle + ratio * Math.PI * 2;
        const hue = (i * 360 / n) % 360;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = `hsl(${hue} 70% 55% / 0.95)`;
        ctx.fill();
        startAngle = endAngle;
      });
      // 穴
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath(); ctx.arc(centerX, centerY, innerR, 0, Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation = 'source-over';

      // 凡例
      const legendX = 12, legendY = 12, lineH = 22;
      let j = 0;
      expenses.forEach((r, i) => {
        const val = r.amountMonthly||0; if (!val) return;
        const hue = (i * 360 / n) % 360;
        const y = legendY + j*lineH;
        ctx.fillStyle = `hsl(${hue} 70% 55%)`;
        ctx.fillRect(legendX, y+4, 12, 12);
        ctx.fillStyle = '#e5e7eb';
        ctx.font = '12px system-ui, sans-serif';
        const label = `${r.name}：¥${fmt.format(monthlyToView(val))}`;
        ctx.fillText(label, legendX + 18, y + 12);
        j++;
      });
    }

    // ---- 永続化（ローカルストレージ & プロフィール保存）
    function serialize() {
      return {
        incomes: getRows(incomeTBody),
        expenses: getRows(expenseTBody)
      };
    }
    function deserialize(data) {
      incomeTBody.innerHTML = ''; expenseTBody.innerHTML = '';
      (data.incomes||[]).forEach(r => incomeTBody.appendChild(createRow(r.name, r.amountMonthly||0, r.memo||'')));
      (data.expenses||[]).forEach(r => expenseTBody.appendChild(createRow(r.name, r.amountMonthly||0, r.memo||'')));
      recalc();
    }

    function saveAuto() {
      localStorage.setItem('pl_auto', JSON.stringify(serialize()));
    }
    function loadAuto() {
      const raw = localStorage.getItem('pl_auto');
      if (raw) {
        try { const data = JSON.parse(raw); deserialize(data); } catch(e) { console.warn(e); }
      } else {
        DEFAULT_INCOME.forEach(n => incomeTBody.appendChild(createRow(n, 0)));
        DEFAULT_EXPENSE.forEach(n => expenseTBody.appendChild(createRow(n, 0)));
      }
    }

    document.addEventListener('input', (e) => {
      if (e.target.matches('.amount, .name, .memo')) saveAuto();
    });

    // プロフィール保存/読込（複数パターン管理）
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const profileName = document.getElementById('profileName');

    saveBtn.addEventListener('click', () => {
      const key = profileName.value.trim();
      if (!key) return alert('プロフィール名を入力してください');
      localStorage.setItem('pl_profile_' + key, JSON.stringify(serialize()));
      alert('保存しました：' + key);
    });
    loadBtn.addEventListener('click', () => {
      const key = prompt('読み込むプロフィール名を入力（保存済みの名前）');
      if (!key) return;
      const raw = localStorage.getItem('pl_profile_' + key);
      if (!raw) return alert('見つかりません：' + key);
      try { deserialize(JSON.parse(raw)); profileName.value = key; saveAuto(); }
      catch(e){ alert('読込に失敗しました'); }
    });

    // 追加・初期化
    document.getElementById('addIncome').addEventListener('click', () => {
      incomeTBody.appendChild(createRow('新しい収入', 0));
      saveAuto();
    });
    document.getElementById('addExpense').addEventListener('click', () => {
      expenseTBody.appendChild(createRow('新しい支出', 0));
      saveAuto();
    });
    document.getElementById('resetAll').addEventListener('click', () => {
      if (!confirm('すべて初期化します。よろしいですか？')) return;
      localStorage.removeItem('pl_auto'); localStorage.removeItem('pl_seeded');
      incomeTBody.innerHTML=''; expenseTBody.innerHTML='';
      seedDefaults();
    });

    // CSV 書き出し/読み込み
    function toCSV(data) {
      const esc = (s) => '"' + String(s).replace(/"/g,'""') + '"';
      const rows = [['type','name','amountMonthly','memo']];
      data.incomes.forEach(r => rows.push(['income', r.name, r.amountMonthly, r.memo]));
      data.expenses.forEach(r => rows.push(['expense', r.name, r.amountMonthly, r.memo]));
      return rows.map(r => r.map(esc).join(',')).join('\n');
    }
    function fromCSV(text) {
      // とてもシンプルなCSVパーサ（カンマ/ダブルクオート対応）
      const rows = [];
      let i = 0, field = '', inQ = false, row = [];
      while (i < text.length) {
        const ch = text[i++];
        if (inQ) {
          if (ch === '"') {
            if (text[i] === '"') { field += '"'; i++; } else { inQ = false; }
          } else { field += ch; }
        } else {
          if (ch === '"') { inQ = true; }
          else if (ch === ',') { row.push(field); field = ''; }
          else if (ch === '\n' || ch === '\r') { if (field!=='' || row.length) { row.push(field); rows.push(row); row=[]; field=''; } }
          else { field += ch; }
        }
      }
      if (field!=='' || row.length) { row.push(field); rows.push(row); }

      const header = rows.shift();
      const idx = Object.fromEntries(header.map((h, j) => [h, j]));
      const incomes = [], expenses = [];
      for (const r of rows) {
        const rec = {
          type: r[idx.type],
          name: r[idx.name],
          amountMonthly: Number(r[idx.amountMonthly] || 0),
          memo: r[idx.memo] || ''
        };
        if (rec.type === 'income') incomes.push(rec); else if (rec.type === 'expense') expenses.push(rec);
      }
      return { incomes, expenses };
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
      const csv = toCSV(serialize());
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'personal_pl.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importCsv').addEventListener('change', (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try { const data = fromCSV(String(reader.result)); deserialize(data); saveAuto(); alert('CSV を読み込みました'); }
        catch (err) { alert('CSV の読み込みに失敗しました'); }
      };
      reader.readAsText(file, 'utf-8');
      e.target.value = '';
    });

    // 印刷
    document.getElementById('printBtn').addEventListener('click', () => window.print());

    // 表示モード変更
    viewMode.addEventListener('change', recalc);

    // 初期化
    seedDefaults();

    // レスポンシブでキャンバス再描画
    let resizeTimer; window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(recalc, 150); });
  </script>
</body>
</html>
